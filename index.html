<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Canlı Kurlar</title>

  <style>
    body {
      margin: 0;
      background: #0f1115;
      color: #fff;
      font-family: Segoe UI, Roboto, Arial, sans-serif;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    header {
      position: absolute;
      left: 15px;
      bottom: 95px;
      font-size: 16px;
      color: #bbb;
    }

    footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.8);
      border-top: 1px solid #222;
      box-sizing: border-box;
    }

    .card {
      flex: 1;
      text-align: center;
      margin: 0 5px;
      background: #1a1f29;
      border-radius: 12px;
      padding: 8px 6px;
      font-size: 18px;
    }

    .label { font-size: 12px; color: #aaa; margin-bottom: 4px; }
    .value { font-weight: bold; font-size: 22px; transition: color .3s; }
    .up { color: #18c964; }
    .down { color: #ff4d4f; }
  </style>
</head>

<body>

  <header><span id="time">Yükleniyor...</span></header>

  <footer>
    <div class="card"><div class="label">USD / TRY</div><div id="usd" class="value">--</div></div>
    <div class="card"><div class="label">EUR / TRY</div><div id="eur" class="value">--</div></div>
    <div class="card"><div class="label">GBP / TRY</div><div id="gbp" class="value">--</div></div>
    <div class="card"><div class="label">GRAM ALTIN</div><div id="gold" class="value">--</div></div>
  </footer>

  <script>
    const el = id => document.getElementById(id);
    const OER_KEY = "7ac0eb5b948f4a4e9e929a3164e3808a";

    let cache = { usd: null, eur: null, gbp: null, gold: null };
    let last = {};
    let lastRealUpdate = null;

    function updateValue(id, val) {
      const box = el(id);
      const num = parseFloat(val);
      if (isNaN(num)) {
        box.textContent = "--";
        box.className = "value";
        return;
      }

      const prev = last[id];
      last[id] = num;
      cache[id] = num;
      box.textContent = num.toFixed(2);

      if (prev !== undefined) {
        if (num > prev) box.className = "value up";
        else if (num < prev) box.className = "value down";
        else box.className = "value";
      } else {
        box.className = "value";
      }
    }

    function refreshDisplay() {
      ["usd","eur","gbp","gold"].forEach(id => {
        if (cache[id] != null) {
          el(id).textContent = cache[id].toFixed(2);
        }
      });

      if (lastRealUpdate)
        el("time").textContent = "Son güncelleme: " +
          lastRealUpdate.toLocaleTimeString("tr-TR", {hour12:false});
    }

    // ---- Döviz (saatte bir)
    async function fetchRates() {
      try {
        const lastCall = parseInt(localStorage.getItem("lastFetchTime") || "0", 10);
        const now = Date.now();
        if (now - lastCall < 3600000) return;

        const url = `https://openexchangerates.org/api/latest.json?app_id=${OER_KEY}&symbols=EUR,GBP,TRY`;
        const res = await fetch(url);
        const json = await res.json();
        const r = json.rates;

        updateValue("usd", r.TRY);
        updateValue("eur", r.TRY / r.EUR);
        updateValue("gbp", r.TRY / r.GBP);

        lastRealUpdate = new Date(json.timestamp * 1000);
        localStorage.setItem("lastFetchTime", now);
        refreshDisplay();
      } catch(e){
        console.log("Döviz hatası:", e);
      }
    }

    // ---- Altın (15 saniyede bir)
    async function fetchGold() {
      try {
        if (!cache.usd) return;

        const res = await fetch("https://api.metals.live/v1/spot");
        const json = await res.json();

        const onsUsd = json[0].gold;
        if (!onsUsd) return;

        const gramTry = (onsUsd * cache.usd) / 31.1035;

        updateValue("gold", gramTry);
      } catch (e) {
        console.log("Altın hatası:", e);
      }
    }

    // İlk yükleme
    fetchRates();
    fetchGold();
    refreshDisplay();

    // Döviz -> saatlik
    setInterval(fetchRates, 60 * 60 * 1000);

    // Altın -> 15 saniye
    setInterval(fetchGold, 15000);

    // Ekranı yenile (yeşil/kırmızı animasyon kalsın)
    setInterval(refreshDisplay, 15000);

  </script>

</body>
</html>
