<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Canlı Kurlar</title>

  <style>
    body {
      margin: 0;
      background: #0f1115;
      color: #fff;
      font-family: Segoe UI, Roboto, Arial, sans-serif;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    header {
      position: absolute;
      left: 15px;
      bottom: 95px;
      font-size: 15px;
      color: #bbb;
    }

    footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.8);
      border-top: 1px solid #222;
      box-sizing: border-box;
    }

    .card {
      flex: 1;
      text-align: center;
      margin: 0 5px;
      background: #1a1f29;
      border-radius: 12px;
      padding: 8px 6px;
      box-sizing: border-box;
    }

    .label { font-size: 12px; color: #aaa; margin-bottom: 4px; }
    .value { font-size: 22px; font-weight: bold; transition: color .3s; }
    .up { color: #18c964; }
    .down { color: #ff4d4f; }
  </style>
</head>

<body>

  <header><span id="time">Yükleniyor...</span></header>

  <footer>
    <div class="card"><div class="label">USD / TRY</div><div id="usd" class="value">--</div></div>
    <div class="card"><div class="label">EUR / TRY</div><div id="eur" class="value">--</div></div>
    <div class="card"><div class="label">GBP / TRY</div><div id="gbp" class="value">--</div></div>
    <div class="card"><div class="label">GRAM ALTIN</div><div id="gold" class="value">--</div></div>
  </footer>

  <script>
    const el = id => document.getElementById(id);
    const OER_APP_ID = "7ac0eb5b948f4a4e9e929a3164e3808a";

    const cache = { usd: null, eur: null, gbp: null, gold: null };
    const last = {};
    let lastRealUpdate = null;

    /** EKRANA YAZDIRMA **/
    function updateValue(id, val) {
      const e = el(id);
      if (!e) return;

      if (val == null || isNaN(val)) {
        e.textContent = "--";
        return;
      }

      const prev = last[id];
      last[id] = val;

      e.textContent = val.toFixed(2);

      if (prev !== undefined) {
        if (val > prev) e.className = "value up";
        else if (val < prev) e.className = "value down";
        else e.className = "value";
      }
    }

    function showTime() {
      if (!lastRealUpdate) return;
      el("time").textContent = "Son güncelleme: " +
        lastRealUpdate.toLocaleTimeString("tr-TR", { hour12: false });
    }

    setInterval(showTime, 1000);

    /** DÖVİZ (OpenExchange – saatlik) **/
    async function fetchRates() {
      try {
        const url = `https://openexchangerates.org/api/latest.json?app_id=${OER_APP_ID}&symbols=EUR,GBP,TRY`;
        const res = await fetch(url);
        const json = await res.json();

        const r = json.rates;
        const usdtry = r.TRY;
        const eurtry = r.TRY / r.EUR;
        const gbptry = r.TRY / r.GBP;

        cache.usd = usdtry;
        cache.eur = eurtry;
        cache.gbp = gbptry;

        updateValue("usd", usdtry);
        updateValue("eur", eurtry);
        updateValue("gbp", gbptry);

        lastRealUpdate = new Date(json.timestamp * 1000);

      } catch (e) {
        console.log("Döviz alınamadı:", e);
      }
    }

    /** ALTIN (15 saniyede bir – truncgil embed, CORS yok) **/
    async function fetchGold() {
      try {
        const proxy = "https://api.allorigins.win/raw?url=";
        const url = proxy + encodeURIComponent("https://finans.truncgil.com/today.json");

        const res = await fetch(url);
        const json = await res.json();

        if (!json || !json["Gram Altın"]) {
          console.log("Altın verisi bulunamadı:", json);
          return;
        }

        const metal = json["Gram Altın"];
        const alis = parseFloat(metal.Alış.replace(",", "."));

        if (!isNaN(alis)) {
          cache.gold = alis;
          updateValue("gold", alis);
        }

      } catch (e) {
        console.log("Altın alınamadı:", e);
      }
    }

    /** Başlat **/
    fetchRates();                 // döviz ilk yükleme
    fetchGold();                  // altın ilk yükleme
    setInterval(fetchRates, 3600000); // 1 saat
    setInterval(fetchGold, 15000);    // 15 sn
  </script>

</body>
</html>
